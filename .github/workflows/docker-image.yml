name: Docker Image CI
on:
  push:
    branches: [main, setup/ci]
  pull_request:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      max-parallel: 2
      matrix:
        ghc: ["8.8.4"]
        resolver: ["lts-16.12"]
    steps:
    - uses: actions/checkout@v2
    - uses: satackey/action-docker-layer-caching@v0.0.11
      # Ignore the failure of a step and avoid terminating the job.
      continue-on-error: true
      with:
        key: docker-layer-cache-{hash}
        restore-keys: |
          docker-layer-cache-
    - name: Build the Docker image
      run: >
          docker build ./.devcontainer/
          --file ./.devcontainer/Dockerfile
          --build-arg GHC_VERSION=${{ matrix.ghc }}
          --build-arg STACK_RESOLVER=${{ matrix.resolver }}
          --tag vlza/haskelldevenv:${{ matrix.ghc }}-${{ matrix.resolver }}-$(date +%s)

# TODO: Trigger release on tag, publish containers.
